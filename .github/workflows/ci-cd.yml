name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  GCP_ZONE: us-central1-a
  GKE_CLUSTER: pickstream-cluster
  NAMESPACE: pickstream
  HELM_RELEASE: pickstream
  GCP_REGION: us-central1
  ARTIFACT_REGISTRY: us-central1-docker.pkg.dev

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
    environment:
      name: development
      url: https://pickstream-dev.example.com
    
    permissions:
      contents: read
      id-token: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        install_components: 'gke-gcloud-auth-plugin'
      
    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build and push backend image
      uses: docker/build-push-action@v5
      with:
        context: services/backend
        push: true
        tags: |
          ${{ env.ARTIFACT_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/pickstream/pickstream-backend:${{ github.sha }}
          ${{ env.ARTIFACT_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/pickstream/pickstream-backend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Build and push frontend image
      uses: docker/build-push-action@v5
      with:
        context: services/frontend
        push: true
        tags: |
          ${{ env.ARTIFACT_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/pickstream/pickstream-frontend:${{ github.sha }}
          ${{ env.ARTIFACT_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/pickstream/pickstream-frontend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone=${{ env.GCP_ZONE }} \
          --project=${{ secrets.GCP_PROJECT_ID }}
      
    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.13.0'
        
    - name: Create namespace if not exists
      run: |
        if kubectl get namespace ${{ env.NAMESPACE }} > /dev/null 2>&1; then
          echo "Namespace exists, adding Helm labels..."
          kubectl label namespace ${{ env.NAMESPACE }} app.kubernetes.io/managed-by=Helm --overwrite || true
          kubectl annotate namespace ${{ env.NAMESPACE }} meta.helm.sh/release-name=${{ env.HELM_RELEASE }} --overwrite || true
          kubectl annotate namespace ${{ env.NAMESPACE }} meta.helm.sh/release-namespace=${{ env.NAMESPACE }} --overwrite || true
        else
          echo "Creating namespace..."
          kubectl create namespace ${{ env.NAMESPACE }}
          kubectl label namespace ${{ env.NAMESPACE }} app.kubernetes.io/managed-by=Helm
          kubectl annotate namespace ${{ env.NAMESPACE }} meta.helm.sh/release-name=${{ env.HELM_RELEASE }}
          kubectl annotate namespace ${{ env.NAMESPACE }} meta.helm.sh/release-namespace=${{ env.NAMESPACE }}
        fi
        
    - name: Deploy with Helm
      run: |
        helm upgrade --install ${{ env.HELM_RELEASE }} ./helm/pickstream \
          --namespace ${{ env.NAMESPACE }} \
          --values ./helm/pickstream/values.yaml \
          --set global.projectId=${{ secrets.GCP_PROJECT_ID }} \
          --set backend.image.tag=${{ github.sha }} \
          --set frontend.image.tag=${{ github.sha }} \
          --wait \
          --timeout 10m
          
    - name: Verify deployment
      run: |
        kubectl rollout status deployment/pickstream-backend -n ${{ env.NAMESPACE }} --timeout=5m
        kubectl rollout status deployment/pickstream-frontend -n ${{ env.NAMESPACE }} --timeout=5m
        
    - name: Run smoke tests
      run: |
        echo "Waiting for services to be ready..."
        sleep 30
        
        # Test backend health
        kubectl port-forward -n ${{ env.NAMESPACE }} svc/pickstream-backend 8080:8080 &
        PF_PID=$!
        sleep 5
        
        curl -f http://localhost:8080/api/health || exit 1
        echo "✓ Backend health check passed"
        
        curl -f http://localhost:8080/api/random-name || exit 1
        echo "✓ Backend API working"
        
        kill $PF_PID
        
    - name: Get deployment info
      if: always()
      run: |
        echo "=== Deployment Summary ==="
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Author: ${{ github.actor }}"
        echo ""
        echo "=== Pods ==="
        kubectl get pods -n ${{ env.NAMESPACE }}
        echo ""
        echo "=== Services ==="
        kubectl get svc -n ${{ env.NAMESPACE }}
        echo ""
        echo "=== Ingress ==="
        kubectl get ingress -n ${{ env.NAMESPACE }}
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "❌ Deployment failed! Check the logs above for details."
        kubectl logs -n ${{ env.NAMESPACE }} -l app.kubernetes.io/component=backend --tail=50 || true
        kubectl logs -n ${{ env.NAMESPACE }} -l app.kubernetes.io/component=frontend --tail=50 || true

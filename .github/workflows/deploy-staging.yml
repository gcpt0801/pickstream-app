name: Deploy to Staging

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: true
        default: 'latest'

env:
  GCP_REGION: us-central1
  GKE_CLUSTER: pickstream-staging
  NAMESPACE: pickstream
  HELM_RELEASE: pickstream

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://pickstream-staging.example.com
    
    permissions:
      contents: read
      id-token: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --region=${{ env.GCP_REGION }} \
          --project=${{ secrets.GCP_PROJECT_ID }}
      
    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.13.0'
        
    - name: Create namespace if not exists
      run: |
        kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
        
    - name: Deploy with Helm
      run: |
        helm upgrade --install ${{ env.HELM_RELEASE }} ./helm/pickstream \
          --namespace ${{ env.NAMESPACE }} \
          --values ./helm/pickstream/values.yaml \
          --values ./helm/pickstream/values-staging.yaml \
          --set global.projectId=${{ secrets.GCP_PROJECT_ID }} \
          --set backend.image.tag=${{ github.event.inputs.image_tag }} \
          --set frontend.image.tag=${{ github.event.inputs.image_tag }} \
          --wait \
          --timeout 5m
          
    - name: Verify deployment
      run: |
        kubectl rollout status deployment/pickstream-backend -n ${{ env.NAMESPACE }} --timeout=5m
        kubectl rollout status deployment/pickstream-frontend -n ${{ env.NAMESPACE }} --timeout=5m
        
    - name: Run smoke tests
      run: |
        echo "Waiting for services to be ready..."
        sleep 30
        
        kubectl port-forward -n ${{ env.NAMESPACE }} svc/pickstream-backend 8080:8080 &
        PF_PID=$!
        sleep 5
        
        curl -f http://localhost:8080/api/health || exit 1
        echo "âœ“ Backend health check passed"
        
        kill $PF_PID
        
    - name: Get deployment info
      if: always()
      run: |
        echo "=== Deployment Info ==="
        helm list -n ${{ env.NAMESPACE }}
        kubectl get pods -n ${{ env.NAMESPACE }}
        kubectl get svc -n ${{ env.NAMESPACE }}
        kubectl get ingress -n ${{ env.NAMESPACE }}
